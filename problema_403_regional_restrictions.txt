# Problema: 403 Regional Restrictions su Polymarket (POST ordine)

## Contesto
- Bot Python per Polymarket che: trova il mercato BTC Up/Down 5m, legge le quote, piazza **una sola scommessa da 1$** sul lato con quota più alta (UP o DOWN) e si ferma.
- Stack: Python 3, py-clob-client (ClobClient), Gamma API (requests), asyncio.
- L’utente è in **Italia**. Polymarket applica restrizioni geografiche.

## Cosa funziona
- **Discovery mercati**: Gamma API (senza proxy) → trova il market 5m attivo, estrae `clobTokenIds` (UP e DOWN).
- **Quote**: CLOB (midpoint / orderbook) → legge correttamente i prezzi (es. DOWN 72.50%, UP 27.50%).
- **Logica**: il bot sceglie il lato con quota più alta (es. DOWN 72.5%), calcola size per ~1$ (1.38 quote @ 0.7250) e chiama `place_limit_order` (POST ordine al CLOB).

## Errore
Al **POST ordine** (invio ordine al CLOB di Polymarket) la risposta è:

```
PolyApiException[status_code=403, error_message={'error': 'Access restricted. Your request was blocked due to regional restrictions.'}]
```

Quindi: **solo l’endpoint di placing order** restituisce 403; le GET (midpoint, orderbook, Gamma) vanno bene.

## Proxy (stesso che su Replit, dove funziona)
- Stesso proxy **DataImpulse** (Svizzera) usato su **Replit** per lo stesso bot → lì **funziona** (nessun 403).
- Su Replit: variabili `HTTP_PROXY` / `HTTPS_PROXY` (o `PROXY_URL`) nelle Secrets → tutto il traffico passa dal proxy.
- In locale ora il bot imposta `HTTP_PROXY` e `HTTPS_PROXY` da `PROXY_URL` (stessa logica di Replit) così tutte le richieste (Gamma + CLOB) usano il proxy.
- Se in locale il 403 persiste: possibile che la rete locale non faccia passare il traffico dal proxy come Replit (firewall, DNS che non risolve gw.dataimpulse.com, ecc.).

## Ipotesi
1. Polymarket potrebbe bloccare in base a **account/wallet** (paese di registrazione o KYC) e non solo all’**IP** della richiesta.
2. Oppure l’endpoint POST ordine valida la regione in modo diverso (es. header, indirizzo wallet associato all’API key).
3. Il proxy potrebbe non essere usato correttamente per quella specifica richiesta (ma il 403 è esplicito “regional restrictions”, non timeout/proxy error).

## Cosa serve
- Capire se il 403 “Access restricted. Your request was blocked due to regional restrictions” su **POST /order** (CLOB Polymarket) può essere aggirato:
  - solo con proxy/VPN (e in quel caso cosa verificare: IP esce davvero dalla Svizzera? header particolari?),
  - oppure se Polymarket blocca per regione dell’**account** (wallet/API key) e quindi servirebbero account o ambienti “allowed” (es. entità in paese consentito).
- Se esiste documentazione ufficiale Polymarket o py-clob-client su restrizioni geografiche e su quali endpoint/azioni sono bloccati e perché (IP vs account).
- Eventuali workaround noti (es. usare un “relayer” o un servizio che piazza ordini da una regione consentita, senza cambiare wallet).

## Dettaglio tecnico (per replicare)
- **Libreria**: `py_clob_client` → `ClobClient`, `create_and_post_order` → internamente `post_order` che fa una POST all’host CLOB (es. `https://clob.polymarket.com`) con body dell’ordine firmato.
- **Autenticazione**: API key/secret/passphrase Polymarket (L2) da .env; ordine firmato con private key (EOA).
- **Proxy**: impostato solo sul client httpx usato da py_clob_client (patch di `_http_client` in `py_clob_client.http_helpers.helpers` con `httpx.Client(http2=True, proxy=proxy_url)`).
- **Risposta**: HTTP 403, body `{"error": "Access restricted. Your request was blocked due to regional restrictions."}`.
