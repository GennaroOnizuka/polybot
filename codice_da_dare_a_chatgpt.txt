================================================================================
CODICE E CONTESTO — da dare a ChatGPT per capire cosa sbagliamo
================================================================================

OBIETTIVO
---------
Trovare il market Polymarket "Bitcoin Up or Down" (finestre 5 minuti) attualmente 
attivo (endDate nel futuro), chiamando la Gamma API di Polymarket, per poi 
mostrare quote UP/DOWN e operare solo su quel prodotto.

API usata: https://gamma-api.polymarket.com (Gamma API)
Documentazione: https://docs.polymarket.com/developers/gamma-markets-api/get-markets

PROBLEMA ATTUALE
----------------
find_active_btc_5m_market() restituisce sempre None.
Il bot stampa: "No active Bitcoin Up or Down 5m event found" e esce.

Chiamata che facciamo:
  GET https://gamma-api.polymarket.com/markets?closed=false&limit=1000

Filtri che applichiamo in Python:
  - "bitcoin up or down" in market["question"].lower()
  - market["endDate"] parsata e confrontata con now (UTC): endDate > now
  - ordiniamo per endDate e prendiamo il primo (finestra 5m corrente)

Possibili cause che sospettiamo:
  - La risposta di /markets non è una lista ma un oggetto (es. { "data": [...] })?
  - Il parametro "closed" deve essere passato in un altro modo (es. 0/1, true/false)?
  - I market "Bitcoin Up or Down" hanno "question" con testo diverso (es. maiuscole, caratteri)?
  - Il campo data si chiama "endDate" o "end_date" o altro?
  - Servono altri parametri (es. enableOrderBook, tag_id) per avere quei market?

================================================================================
CODICE PYTHON CHE USIAMO (estratti rilevanti)
================================================================================

BASE_URL = "https://gamma-api.polymarket.com"

@staticmethod
def _parse_iso_date(s: str):
    """Parse ISO date from Gamma API (Z → +00:00 for timezone-aware)."""
    from datetime import datetime
    if not s:
        return None
    try:
        return datetime.fromisoformat(s.replace("Z", "+00:00"))
    except Exception:
        return None

def find_active_btc_5m_market(self, limit: int = 1000):
    """
    Trova il market 'Bitcoin Up or Down' attivo (finestra 5m più vicina nel futuro).
    Returns: dict (market) oppure None se non trovato
    """
    from datetime import datetime, timezone
    try:
        response = requests.get(
            f"{self.BASE_URL}/markets",
            params={"closed": "false", "limit": limit},
            timeout=15
        )
        response.raise_for_status()
        markets = response.json()
        if not isinstance(markets, list):
            markets = []
    except Exception as e:
        print("Errore chiamando Gamma API /markets:", e)
        return None

    now = datetime.now(timezone.utc)
    candidates = []

    for m in markets:
        q = m.get("question") or ""
        if not q or "bitcoin up or down" not in q.lower():
            continue
        end_date_str = m.get("endDate") or m.get("end_date")
        if not end_date_str:
            continue
        end_dt = self._parse_iso_date(end_date_str)
        if end_dt is None or end_dt <= now:
            continue
        candidates.append((end_dt, m))

    if not candidates:
        # Debug
        with_bitcoin = sum(1 for m in markets if "bitcoin" in (m.get("question") or "").lower())
        with_phrase = sum(1 for m in markets if "bitcoin up or down" in (m.get("question") or "").lower())
        print(f"   [debug] Gamma /markets: {len(markets)} totali, {with_phrase} con 'bitcoin up or down', {with_bitcoin} con 'bitcoin'. Nessuno con endDate>now?")
        return None
    candidates.sort(key=lambda x: x[0])
    return candidates[0][1]


def get_active_btc_updown_markets(self):
    """Ritorna lista di market per la finestra attiva; usa find_active_btc_5m_market."""
    market = self.find_active_btc_5m_market(limit=1000)
    if not market:
        return []
    event_id = None
    events_arr = market.get("events")
    if events_arr and len(events_arr) > 0 and isinstance(events_arr[0], dict):
        event_id = events_arr[0].get("id")
    if event_id:
        event_markets = self.get_markets_for_event(event_id)
        if event_markets:
            return event_markets
    return [market]

================================================================================
COME VIENE USATO NEL BOT
================================================================================

Quando MONITOR_EVENT_SLUG=btc-updown-5m:

1. Il bot chiama get_active_btc_updown_markets()
2. Questa chiama find_active_btc_5m_market(1000)
3. Se find_active_btc_5m_market restituisce None, get_active_btc_updown_markets restituisce []
4. Il bot non trova market e stampa "No active Bitcoin Up or Down 5m event found" e esce

Su Polymarket la pagina è: https://polymarket.com/event/btc-updown-5m
I singoli market hanno slug tipo "btc-up-or-down-february-12-1015am-et" e question tipo
"Bitcoin Up or Down - February 12, 10:15AM-10:20AM ET?" (quindi "bitcoin up or down" c’è in question).

================================================================================
DOMANDE PER CHATGPT
================================================================================

1. La Gamma API GET /markets con params closed=false e limit=1000 restituisce 
   direttamente un array di market o un oggetto con una chiave (es. "data" o "markets")?

2. Il parametro "closed" va passato come stringa "false" o come booleano False 
   (e come viene serializzato in query string da requests?)?

3. Ci sono parametri obbligatori o consigliati (es. enableOrderBook, tag_slug, 
   order) per ottenere i market "Bitcoin Up or Down" tra i risultati?

4. Il campo della data di chiusura nel singolo market è "endDate", "end_date" 
   o altro? Formato ISO con "Z" è corretto?

5. Se il codice è corretto, perché candidates resta vuoto? Come possiamo 
   ispezionare la risposta reale (es. stampare type(response.json()) e 
   i primi 1-2 market) per adattare filtro e campi?

================================================================================
